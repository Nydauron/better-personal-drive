<html>
    <head>
        <title>Hello</title>
        <link rel="stylesheet" type="text/css" href="/assets/dosis-light.css">
        <style>
            table {
                position: relative;
                left: 50%;
                transform: translateX(-50%);
                width: 80%;
            }
            table th, table td {
                /* font-family: "Dosis-Light", serif; */
                padding: 10px 5px;
            }
            td.item-type, td.item-added, td.item-modified, td.item-accessed {
                text-align: center;
            }
            #fileProgress {
                display: none;
            }
            
            .loader {
                border: 16px solid #f3f3f3;
                border-radius: 50%;
                border-top: 16px solid #3498db;
                width: 120px;
                height: 120px;
                -webkit-animation: spin 2s linear infinite; /* Safari */
                animation: spin 1.2s cubic-bezier(0.105, 0.610, 0.865, 0.400) infinite;
                opacity: 0;
                transition: opacity 0.5s;
            }
            
            .loader.uploadProcessing {
                opacity: 1;
            }

            /* Safari */
            @-webkit-keyframes spin {
                0% { -webkit-transform: rotate(0deg); }
                100% { -webkit-transform: rotate(360deg); }
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            #drive-directory {
                transition: background 1s;
            }
            #drive-directory.draghover {
                background: lightblue;
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.6.0.slim.js"></script>
        <script>
            console.log(window.location.pathname)
            let csrf_token = "{{ csrf_token() }}";
            async function upload_file(inp) {
                let formData = new FormData();
                // var reader = new FileReader();
                let file = inp.files[0];      
                     
                formData.append("file", file);
                formData.append("modified_at", file.lastModifiedDate.toISOString());
                // formData.append("name", file.name);
                
                // const ctrl = new AbortController()    // timeout
                // setTimeout(() => ctrl.abort(), 5000);
                
                // try {
                //     url = "/upload";
                //     if (window.location.pathname != '/'){
                //         url = window.location.pathname + url;
                //     }
                //     let r = await fetch(url, 
                //         {method: "POST", body: formData}); //, signal: ctrl.signal}); 
                //     console.log('HTTP response code:',r.status); 
                // } catch(e) {
                //     console.log('Huston we have problem...:', e);
                // }
                
                progressBar = document.getElementById('fileProgress');
                progressBar.style.display = 'block';
                
                url = "/upload";
                if (window.location.pathname != '/'){
                    url = window.location.pathname + url;
                }
                let request = new XMLHttpRequest();
                
                request.open('POST', url);
                request.setRequestHeader("X-CSRFToken", csrf_token);
                request.addEventListener('load', function(e) {
                    document.getElementById('upload-spin').classList.remove("uploadProcessing");
                    console.log(request.response);
                    console.log("transfer complete")
                });
                request.upload.addEventListener('progress', function(e) {
                	let percent_complete = (e.loaded / e.total)*100;
                	
                    if (percent_complete < 100) {
                        progressBar.value = percent_complete;
                        progressBar.innerHTML = percent_complete + "%";
                    } else {
                        progressBar.style.display = 'none';
                        document.getElementById('upload-spin').classList.add("uploadProcessing");
                    }
                	// percentage of upload completed
                	console.log(percent_complete);
                });
                request.send(formData);
            }
            
            function dropHandler(ev) {
                console.log('File(s) dropped');

                // Prevent default behavior (Prevent file from being opened)
                ev.preventDefault();

                if (ev.dataTransfer.items) {
                // Use DataTransferItemList interface to access the file(s)
                for (var i = 0; i < ev.dataTransfer.items.length; i++) {
                    // If dropped items aren't files, reject them
                    if (ev.dataTransfer.items[i].kind === 'file') {
                        var file = ev.dataTransfer.items[i].getAsFile();
                        console.log('... file[' + i + '].name = ' + file.name);
                    }
                }
                } else {
                // Use DataTransfer interface to access the file(s)
                    for (var i = 0; i < ev.dataTransfer.files.length; i++) {
                        console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
                    }
                }
            }
            
            async function mkdir(inp) {
                if (event.keyCode != 13) {
                    return;
                }
                let formData = new FormData();
                // var reader = new FileReader();
                let folder = inp.value;      
                     
                formData.append("name", folder);
                // formData.append("name", file.name);
                
                // const ctrl = new AbortController()    // timeout
                // setTimeout(() => ctrl.abort(), 5000);
                
                try {
                    url = "/mkdir";
                    if (window.location.pathname != '/'){
                        url = window.location.pathname + url;
                    }
                    let r = await fetch(url, 
                        {method: "POST", headers: {"X-CSRFToken": csrf_token}, body: formData}); //, signal: ctrl.signal}); 
                    console.log('HTTP response code:',r.status); 
                } catch(e) {
                    console.log('Huston we have problem...:', e);
                }
            }
            
            function dragEnterHandler(ev) {
                ev.preventDefault();
                document.getElementById('drive-directory').classList.add('draghover');
            }
            function dragLeaveHandler(ev) {
                ev.preventDefault();
                document.getElementById('drive-directory').classList.remove('draghover');
            }
            
            $(document).ready(() => {
                refreshDirectory();
            });
            
            function refreshDirectory() {
                console.log(window.location.pathname)
                
                let request = new XMLHttpRequest();
                let url = "/dir" + window.location.pathname;
                
                request.open('GET', url);
                request.addEventListener('load', function(e) {
                    if (request.status == 200) {
                        DIR_ITEMS = JSON.parse(request.response)['items'];
                        sortAndDisplayDir(sortByName);
                    }
                });
                
                request.send();
            }
            
            function sortAndDisplayDir(comFunct) {
                DIR_ITEMS.sort(comFunct);
                $('#table-directory').html('');
                drawHeaderRow();
                DIR_ITEMS.forEach((e) => {
                    drawDirRow(e);
                });
            }
            
            function drawHeaderRow() {
                table = $('#table-directory');
                cells = [
                    $('<th></th>', {text: 'Name'}),
                    $('<th></th>', {text: 'Type'}),
                    $('<th></th>', {text: 'Date Added'}),
                    $('<th></th>', {text: 'Last Modified'}),
                    $('<th></th>', {text: 'Last Accessed'})
                ];
                table.append($('<tr></tr>').append(cells));
            }
            
            function drawDirRow(dir_info) {
                table = $('#table-directory');
                cells = [
                    $('<td></td>', {class: 'item-name'}).append($('<a></a>', {text: dir_info['name'], href: "/" + dir_info['uuid']})),
                    $('<td></td>', {class: 'item-type', text: dir_info['type']}),
                    $('<td></td>', {class: 'item-added', text: (new Date(dir_info['created_at'])).toLocaleString()}),
                    $('<td></td>', {class: 'item-modified', text: (new Date(dir_info['last_modified_at'])).toLocaleString()}),
                    $('<td></td>', {class: 'item-accessed', text: (new Date(dir_info['last_accessed_at'])).toLocaleString()})
                ];
                table.append($('<tr></tr>').append(cells));
                
            }
            
            function sortByName(el1, el2) {
                if (el1.type === 'folder' && el2.type != "folder") {
                    return -1;
                }
                if (el1.type != 'folder' && el2.type === "folder") {
                    return 1;
                }
                
                return el1.name.toLowerCase().localeCompare(el2.name.toLowerCase());
            }
            
            function sortByAdded(el1, el2) {
                if (el1.type === 'folder' && el2.type != "folder") {
                    return 1;
                }
                if (el1.type != 'folder' && el2.type === "folder") {
                    return -1;
                }
                
                return (new Date(el2['created_at'])).getTime() - (new Date(el1['created_at'])).getTime();
            }
        </script>
    </head>
    
    <body>
        {% include 'header.html' %}
        <section>
            <article id="drive-directory" ondragenter="dragEnterHandler(event)" ondragleave="dragLeaveHandler(event)" ondragover="event.preventDefault()" ondrop="dropHandler(event)">
                <table id="table-directory">
                    <tr>
                        <td>KEKWait, there's nothing here.<td>
                    </tr>
                </table>
            </article>
        </section>
        <input type="file" id="fileUpload" name="filename" onchange="upload_file(this)">
        <progress id="fileProgress" value="0" max="100"></progress><div id="upload-spin" class="loader"></div><br>
        <input type="text" id="mkdir" name="name" placeholder="New Folder" onkeydown="mkdir(this)">
    </body>
</html>